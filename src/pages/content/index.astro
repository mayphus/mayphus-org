---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';

const collection = await getCollection('content');
const nodes = collection
  .filter(node => node.data)
  .sort((a, b) => (b.data.date?.valueOf() ?? 0) - (a.data.date?.valueOf() ?? 0));

const tagSet = new Set<string>();
nodes.forEach(node => node.data.filetags?.forEach(tag => tagSet.add(tag)));
const tags = Array.from(tagSet).sort();
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Content - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to main content</a>
    <main id="main">
      <h1><a href="/">Content</a></h1>
      <article>
        <div class="tag-filter">
          {tags.map(tag => (
            <button class="tag-button" data-tag={tag}>{tag}</button>
          ))}
          <button class="clear-button" data-action="clear">Clear</button>
        </div>

        <ul id="items">
          {nodes.map(node => (
            <li data-tags={(node.data.filetags ?? []).join(' ')}>
              <a href={`/content/${node.data.slug}/`}>{node.data.title}</a>
            </li>
          ))}
        </ul>
      </article>
      <Footer />
    </main>
    <style>
      /* Override global max-width for this page */
      body {
        max-width: none;
        padding: var(--space-lg) var(--space-xl);
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
      }

      .tag-filter {
        margin-bottom: var(--space-lg);
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .tag-button, .clear-button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-family: var(--font-sans);
        font-size: 0.875rem;
        text-decoration: none;
      }

      .tag-button:hover, .clear-button:hover {
        border-color: var(--text);
      }

      .tag-button.active {
        background: var(--text);
        color: var(--bg);
        border-color: var(--text);
      }

      .clear-button {
        color: var(--text-light);
        border-color: var(--text-light);
      }

      .clear-button:hover {
        color: var(--text);
      }

      #items {
        list-style: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 0.25rem;
        margin-top: var(--space-lg);
      }

      #items li {
        margin-bottom: 0;
      }

      #items li a {
        display: block;
        font-size: 1rem;
        line-height: 1.4;
        padding: 0.25rem 0;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          padding: var(--space-md);
        }
        
        #items {
          grid-template-columns: 1fr;
          gap: 0;
        }
        
        #items li a {
          padding: 0.25rem 0;
        }
      }

      @media (max-width: 480px) {
        .tag-filter {
          gap: 0.25rem;
        }
        
        .tag-button, .clear-button {
          padding: 0.2rem 0.5rem;
          font-size: 0.8rem;
        }
      }
    </style>
    <script>
      const tagButtons = document.querySelectorAll<HTMLButtonElement>('.tag-button');
      const clearButton = document.querySelector<HTMLButtonElement>('.clear-button');
      const items = Array.from(document.querySelectorAll<HTMLLIElement>('#items li'));
      let selectedTags = new Set<string>();

      function updateDisplay() {
        // Update button states
        tagButtons.forEach(btn => {
          const tag = btn.dataset.tag!;
          btn.classList.toggle('active', selectedTags.has(tag));
        });

        // Filter items
        items.forEach(li => {
          const itemTags = li.dataset.tags ? li.dataset.tags.split(' ') : [];
          const matches = selectedTags.size === 0 || 
            Array.from(selectedTags).every(tag => itemTags.includes(tag));
          li.hidden = !matches;
        });

        // Update URL
        const query = selectedTags.size > 0 ? 
          `?tags=${Array.from(selectedTags).join(',')}` : '';
        history.replaceState(null, '', query);
      }

      // Add click handlers for tag buttons
      tagButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = btn.dataset.tag!;
          if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
          } else {
            selectedTags.add(tag);
          }
          updateDisplay();
        });
      });

      // Add clear button handler
      clearButton?.addEventListener('click', () => {
        selectedTags.clear();
        updateDisplay();
      });

      // Handle initial URL parameters
      const params = new URLSearchParams(location.search);
      const initialTags = params.get('tags');
      if (initialTags) {
        selectedTags = new Set(initialTags.split(','));
        updateDisplay();
      }
    </script>
  </body>
</html>